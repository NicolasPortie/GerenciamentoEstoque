@page "/produtos"
@using Microsoft.EntityFrameworkCore
@using GerenciamentoEstoque.Models
@using GerenciamentoEstoque.Data
@inject IDbContextFactory<AppDbContext> DbFactory
@attribute [Microsoft.AspNetCore.Authorization.Authorize]

<div class="p-6">
    <div class="flex items-center justify-between mb-6">
        <h1 class="text-xl font-bold text-gray-800">Produtos</h1>
        <button class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">
            Novo Produto
        </button>
    </div>

    <!-- Filtro -->
    <div class="bg-white p-4 rounded-lg border border-gray-200 mb-4">
        <input type="text" 
               placeholder="Buscar produto..." 
               class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:border-blue-500 text-sm"
               @bind="filtro" @bind:event="oninput" />
    </div>

    <!-- Tabela -->
    <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
        <table class="w-full text-sm">
            <thead class="bg-gray-50 border-b">
                <tr>
                    <th class="px-4 py-3 text-left text-gray-600 font-medium">Produto</th>
                    <th class="px-4 py-3 text-left text-gray-600 font-medium">Categoria</th>
                    <th class="px-4 py-3 text-center text-gray-600 font-medium">Estoque</th>
                    <th class="px-4 py-3 text-right text-gray-600 font-medium">Preco</th>
                    <th class="px-4 py-3 text-center text-gray-600 font-medium">Status</th>
                    <th class="px-4 py-3 text-right text-gray-600 font-medium">Acoes</th>
                </tr>
            </thead>
            <tbody>
                @if (produtosFiltrados == null)
                {
                    <tr>
                        <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                            Carregando...
                        </td>
                    </tr>
                }
                else if (!produtosFiltrados.Any())
                {
                    <tr>
                        <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                            Nenhum produto encontrado.
                        </td>
                    </tr>
                }
                else
                {
                    @foreach (var prod in produtosFiltrados)
                    {
                        <tr class="border-b hover:bg-gray-50">
                            <td class="px-4 py-3">
                                <div class="font-medium text-gray-800">@prod.Nome</div>
                                <div class="text-xs text-gray-500">@(prod.CodigoInterno ?? "-")</div>
                            </td>
                            <td class="px-4 py-3 text-gray-600">@prod.Categoria.Nome</td>
                            <td class="px-4 py-3 text-center">
                                @{
                                    var qtd = prod.Estoque?.QuantidadeAtual ?? 0;
                                    var min = prod.Estoque?.QuantidadeMinima ?? 0;
                                }
                                <span class="@(qtd <= min ? "text-red-600" : "text-gray-800")">@qtd</span>
                            </td>
                            <td class="px-4 py-3 text-right text-gray-800">R$ @prod.PrecoVenda.ToString("N2")</td>
                            <td class="px-4 py-3 text-center">
                                <span class="@(prod.Ativo ? "text-green-600" : "text-gray-400")">
                                    @(prod.Ativo ? "Ativo" : "Inativo")
                                </span>
                            </td>
                            <td class="px-4 py-3 text-right">
                                <button class="text-blue-600 hover:underline text-sm mr-2">Editar</button>
                                <button class="text-red-600 hover:underline text-sm">Excluir</button>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
    
    <div class="mt-4 text-sm text-gray-500">
        Total: @(totalProdutos) produtos
    </div>
</div>

@code {
    private List<Produto>? produtos;
    private List<Categoria> categorias = new();
    private string filtro = "";
    private int totalProdutos = 0;

    private List<Produto>? produtosFiltrados => produtos?
        .Where(p => string.IsNullOrWhiteSpace(filtro) || 
                   p.Nome.Contains(filtro, StringComparison.OrdinalIgnoreCase) || 
                   (p.CodigoInterno?.Contains(filtro, StringComparison.OrdinalIgnoreCase) ?? false) ||
                   p.Categoria.Nome.Contains(filtro, StringComparison.OrdinalIgnoreCase))
        .ToList();

    protected override async Task OnInitializedAsync()
    {
        await CarregarDados();
    }

    private async Task CarregarDados()
    {
        using var context = DbFactory.CreateDbContext();
        
        categorias = await context.Categorias.Where(c => c.Ativo).OrderBy(c => c.Nome).ToListAsync();
        
        produtos = await context.Produtos
            .Include(p => p.Categoria)
            .Include(p => p.Estoque)
            .OrderByDescending(p => p.DataCadastro)
            .ToListAsync();
            
        totalProdutos = produtos.Count;
    }
}
